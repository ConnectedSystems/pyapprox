

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Numerical Approximations of Governing Equations &mdash; PyApprox 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"V": ["{\\boldsymbol{#1}}", 1], "mean": ["{\\mathbb{E}\\left[#1\\right]}", 1], "var": ["{\\mathbb{V}\\left[#1\\right]}", 1], "argmin": "{\\mathrm{argmin}}", "rv": "z", "reals": "\\mathbb{R}", "pdf": "\\rho", "rvdom": "\\Gamma", "coloneqq": "\\colon=", "norm": ["\\lVert #1 \\rVert", 1], "argmax": ["\\operatorname{argmax}"], "covar": ["\\mathbb{C}\\text{ov}\\left[#1,#2\\right]", 2], "corr": ["\\mathbb{C}\\text{or}\\left[#1,#2\\right]", 2], "ai": "\\alpha", "bi": "\\beta", "dx": ["\\;\\mathrm{d}#1", 1]}}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Monte Carlo Quadrature" href="plot_monte_carlo.html" />
    <link rel="prev" title="PyApprox Tutorials" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> PyApprox
          

          
            
            <img src="../../_static/pyapprox-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">PyApprox Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#foundations">Foundations</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Numerical Approximations of Governing Equations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#partial-differential-equations">Partial Differential Equations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#quantities-of-interest">Quantities of Interest</a></li>
<li class="toctree-l4"><a class="reference internal" href="#numerical-approximations">Numerical Approximations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-advection-diffusion">Example: Advection-Diffusion</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="plot_monte_carlo.html">Monte Carlo Quadrature</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_bayesian_inference.html">Bayesian Inference</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_push_forward_based_inference.html">Push Forward Based Inference</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_tensor_product_interpolation.html">Surrogate Modeling</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_sensitivity_analysis.html">Sensitivity Analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#multi-fidelity-monte-carlo-methods">Multi-Fidelity Monte Carlo Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#polynomial-chaos-expansions">Polynomial Chaos Expansions</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyApprox</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">PyApprox Tutorials</a> &raquo;</li>
        
      <li>Numerical Approximations of Governing Equations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/auto_tutorials/foundations/plot_advection_diffusion_model.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-tutorials-foundations-plot-advection-diffusion-model-py"><span class="std std-ref">here</span></a> to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="numerical-approximations-of-governing-equations">
<span id="sphx-glr-auto-tutorials-foundations-plot-advection-diffusion-model-py"></span><h1>Numerical Approximations of Governing Equations<a class="headerlink" href="#numerical-approximations-of-governing-equations" title="Permalink to this headline">¶</a></h1>
<p>This tutorial discusses the effect of numerically solving governing equations on model uncertainty. The following focuses on models based upon partial differential equations, but the points raised below apply to a much broader class of numerical models.</p>
<div class="section" id="partial-differential-equations">
<h2>Partial Differential Equations<a class="headerlink" href="#partial-differential-equations" title="Permalink to this headline">¶</a></h2>
<p>We seek to quantify uncertainty in a broad class of stochastic partial differential equations (PDE).
Let <span class="math notranslate nohighlight">\(D\subset\mathbb{R}^\ell\)</span>, for <span class="math notranslate nohighlight">\(\ell=1,2,\)</span> or <span class="math notranslate nohighlight">\(3\)</span> and <span class="math notranslate nohighlight">\(\text{dim}(D)=\ell\)</span>, be a physical domain; <span class="math notranslate nohighlight">\(T&gt;0\)</span> be a real number; and <span class="math notranslate nohighlight">\(\rvdom\subseteq
\mathbb{R}^{d}\)</span>, for <span class="math notranslate nohighlight">\(d\geq 1\)</span> and <span class="math notranslate nohighlight">\(\text{dim}(\rvdom)=d\)</span>, be the stochastic space. The PDE is defined as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\left\{
 \begin{array} {ll}
 u_t(x,t,\rv) = \mathcal{L}(u), &amp;\\
\mathcal{B}(u(x, t, \rv)) = 0, &amp; \\
u(x, 0, \rv) = u_0(x, \rv), &amp; %% D\times\{t=0\}\times \rvdom
\end{array}
\right.\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(t\)</span> is the time, <span class="math notranslate nohighlight">\(x=(x_1,\dots,x_\ell)\)</span> is the physical coordinate, <span class="math notranslate nohighlight">\(\mathcal{L}\)</span> is a (nonlinear) differential operator, <span class="math notranslate nohighlight">\(\mathcal{B}\)</span> is the boundary condition operator, <span class="math notranslate nohighlight">\(u_0\)</span> is the initial
condition, and <span class="math notranslate nohighlight">\(\rv=(\rv_1,\dots,\rv_{d})\in \rvdom\)</span>  are a set of random variables characterizing the random inputs to the governing equation.
The solution <span class="math notranslate nohighlight">\(u \in V\)</span> is a vector-valued stochastic quantity</p>
<div class="math notranslate nohighlight">
\[u:\bar{D}\times[0,T]\times \rvdom\to\mathbb{R}^{n},\]</div>
<p>for some suitable function space <span class="math notranslate nohighlight">\(V\)</span> and where <span class="math notranslate nohighlight">\(\bar{D} = D \times \partial D\)</span> is the closure of the interior domain. As an example, <span class="math notranslate nohighlight">\(u(x,t, \rv)\)</span> can be a vector of temperatures, pressures, and velocities for a specific location in the domain <span class="math notranslate nohighlight">\(x\)</span>, specific time <span class="math notranslate nohighlight">\(t\)</span>, and for a specific realization <span class="math notranslate nohighlight">\(\rv\)</span> of the stochastic variable <span class="math notranslate nohighlight">\(\rv\)</span>.</p>
<p>In this tutorial we will consider the following model of advection-diffusion</p>
<div class="math notranslate nohighlight">
\[\begin{split}\frac{\partial u}{\partial t}(x,t,\rv) + \nabla u(x,t,\rv)-\nabla\cdot\left[k(x,\rv) \nabla u(x,t,\rv)\right] &amp;=g(x,t) \qquad\qquad (x,t,\rv)\in D\times [0,1]\times\rvdom\\
u(x,t,\rv)&amp;=0 \qquad\qquad\qquad (x,t,\rv)\in \partial D\times[0,1]\times\rvdom\end{split}\]</div>
<p>with forcing <span class="math notranslate nohighlight">\(g(x,t)=(1.5+\cos(2\pi t))\cos(x_1)\)</span>, and subject to the initial condition <span class="math notranslate nohighlight">\(u(x,0,\rv)=0\)</span>. Following <a class="reference internal" href="#ntwsiamna2008" id="id1"><span>[NTWSIAMNA2008]</span></a>, we model the diffusivity <span class="math notranslate nohighlight">\(k\)</span> as a random field represented by the
Karhunen-Loeve (like) expansion (KLE)</p>
<div class="math notranslate nohighlight">
\[\log(k(x,\rv)-0.5)=1+\rv_1\left(\frac{\sqrt{\pi L}}{2}\right)^{1/2}+\sum_{k=2}^d \lambda_k\phi(x)\rv_k,\]</div>
<p>with</p>
<div class="math notranslate nohighlight">
\[\begin{split}\lambda_k=\left(\sqrt{\pi L}\right)^{1/2}\exp\left(-\frac{(\lfloor\frac{k}{2}\rfloor\pi L)^2}{4}\right) k&gt;1,  \qquad\qquad  \phi(x)=
 \begin{cases}
   \sin\left(\frac{(\lfloor\frac{k}{2}\rfloor\pi x_1)}{L_p}\right) &amp; k \text{ even}\,,\\
   \cos\left(\frac{(\lfloor\frac{k}{2}\rfloor\pi x_1)}{L_p}\right) &amp; k \text{ odd}\,.
 \end{cases}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(L_p=\max(1,2L_c)\)</span>, <span class="math notranslate nohighlight">\(L=\frac{L_c}{L_p}\)</span> and <span class="math notranslate nohighlight">\(L_c=0.5\)</span>.</p>
<p>We choose a random field which is effectively one-dimensional so that the error in the finite element solution is more sensitive to refinement of the mesh in the <span class="math notranslate nohighlight">\(x_1\)</span>-direction than to refinement in the <span class="math notranslate nohighlight">\(x_2\)</span>-direction.</p>
</div>
<div class="section" id="quantities-of-interest">
<h2>Quantities of Interest<a class="headerlink" href="#quantities-of-interest" title="Permalink to this headline">¶</a></h2>
<p>Often, one is more interested in quantifying uncertainty in a particular functional of the solution, called the quantity of interest (QoI), rather than the full solution. Let</p>
<div class="math notranslate nohighlight">
\[F\left[u\right]: V \rightarrow \mathbb{R}^{q}, \qquad q&gt;0\]</div>
<p>be such a function, where <span class="math notranslate nohighlight">\(F\)</span> is typically a continuous and bounded functional. Then, we are interested in estimating statistics of the function</p>
<div class="math notranslate nohighlight">
\[f(\rv)=F[u(\cdot,\rv)] : \Gamma \to \mathbb{R}^{q}.\]</div>
<p>which assigns the value of the quantity of interest <span class="math notranslate nohighlight">\(F[u]\)</span> to each realization of the random variables <span class="math notranslate nohighlight">\(\rv\)</span>.
The above expression allows us to express the QoI as a function of the random variables without needed to explicitly state the dependence of the QoI on the PDE solution.</p>
<p>For the advection-diffusion model we consider the quantity of interest</p>
<div class="math notranslate nohighlight">
\[f(\rv)=\int_D u(\rv)\frac{1}{2\pi\sigma^2}\exp\left(-\frac{\lVert x-x^\star \rVert_2^2}{\sigma^2}\right)\,dx,\]</div>
<p>where <span class="math notranslate nohighlight">\(x^\star=(0.3,0.5)\)</span> and <span class="math notranslate nohighlight">\(\sigma=0.16\)</span>.</p>
</div>
<div class="section" id="numerical-approximations">
<h2>Numerical Approximations<a class="headerlink" href="#numerical-approximations" title="Permalink to this headline">¶</a></h2>
<p>For most, if not all, practical applications, the solutions of the governing equations and statistics of the resulting QoI cannot be computed analytically and numerical approximations must be employed. In the following we will consider finite element approximations, but other approaches such as finite volume and finite difference can also be used.</p>
<p>Given a set of governing equations, we assume access to a PDE solver that approximates the solution <span class="math notranslate nohighlight">\(u\)</span> of these equations for a given <em>fixed</em> <span class="math notranslate nohighlight">\(\rv\)</span>. We also assume this solver has a set of hyper-parameters — mesh size, time step, maximum number of iterations, convergence tolerance, etc. — which can be used to estimate the QoI <span class="math notranslate nohighlight">\(f\)</span> at varying accuracy and cost. Differing settings for these hyper-parameters produces simulations of <em>varying fidelities (resolution)</em>. We refer to approaches that leverage only one model or solver setting as <em>single-fidelity</em> methods and approaches that leverage multiple models and settings as <em>multi-fidelity</em> methods.</p>
<p>The accuracy and cost of a model is often determined by a set of solver parameters, such as mesh size, time step, tolerances of numerical solvers. Let <span class="math notranslate nohighlight">\({n_\ai}\)</span> denote the number of such parameters for a given model. Furthermore let <span class="math notranslate nohighlight">\(l_{\ai_i} \in \mathbb{N}\)</span> denote the number of values that each solver parameter can assume, such that the multi-index <span class="math notranslate nohighlight">\(\ai=(\ai_1,\ldots,\ai_{n_\ai})\in\mathbb{N}^{n_\ai}\)</span>, <span class="math notranslate nohighlight">\(\ai_i\in \mathcal{M}_{\ai_i}=\{1,\ldots,l_{\ai_i}\}\)</span> can be used to index specific values of the solver parameters.
Finally let <span class="math notranslate nohighlight">\(f_\ai(\rv)\)</span> to denote a single-fidelity physical approximation of the QoI <span class="math notranslate nohighlight">\(f(\rv)\)</span> using the solver parameters indexed by <span class="math notranslate nohighlight">\(\ai\)</span>.</p>
<p>The advection-diffusion equation is solved with <a class="reference external" href="https://fenicsproject.org/">Fenics</a> using the Galerkin finite element method with linear finite elements and the implicit backward-Euler time-stepping scheme. Let <span class="math notranslate nohighlight">\(h_1\)</span> and <span class="math notranslate nohighlight">\(h_2\)</span> denote the mesh-size in the spatial directions <span class="math notranslate nohighlight">\(x_1\)</span> and <span class="math notranslate nohighlight">\(x_2\)</span>. Then given some base coarse discretization <span class="math notranslate nohighlight">\(h_{j,0}\)</span>, we create a sequence of <span class="math notranslate nohighlight">\(l_{\ai_j}\)</span> uniform triangular meshes of increasing fidelity by setting (h_{ai_j}=h_{j,0}cdot 2^{-ai_j}`, <span class="math notranslate nohighlight">\(0\le\ai_j&lt;l_{\ai_j}\)</span>, where <span class="math notranslate nohighlight">\(h_{j,0}=\frac{1}{4}\)</span> and <span class="math notranslate nohighlight">\(l_{\ai_j}=6\)</span>, <span class="math notranslate nohighlight">\(j=1,2\)</span>. The number of vertices in the spatial mesh is <span class="math notranslate nohighlight">\((h^{-1}_{\ai_1}+1)(h^{-1}_{\ai_2}+1)\)</span>.</p>
<p>The backward-Euler scheme used to evolve the advection-diffusion equation in time is an implicit method and unconditionally stable; consequently, the time-step size <span class="math notranslate nohighlight">\(\Delta t\)</span> can be made very large. In this paper, we use an ensemble of <span class="math notranslate nohighlight">\(l_{\ai_3}\)</span> time-step sizes <span class="math notranslate nohighlight">\(\Delta t_{\ai_1,\ai_3}=\Delta t_{\ai_3,0}\cdot 2^{-\ai_3}\)</span>, <span class="math notranslate nohighlight">\(0\le\ai_3&lt; l_{\ai_3}\)</span> to solve the advection-diffusion equation  and set <span class="math notranslate nohighlight">\(l_{\ai_3}=6\)</span> and <span class="math notranslate nohighlight">\(\Delta t_{\ai_3,0}=1/4\)</span>.
For high enough <span class="math notranslate nohighlight">\(\ai_1\)</span> and <span class="math notranslate nohighlight">\(\ai_2\)</span>, the ensemble represents a sequence of models of increasing accuracy.</p>
<p>The cost of solving the advection-diffusion is dependent on both the number of mesh vertices and the number of time-steps. The number of mesh vertices is <span class="math notranslate nohighlight">\(2^{(\ai_1+2)(\ai_2+2)}\)</span>, whereas the number of time-steps is <span class="math notranslate nohighlight">\(2^{\ai_3+2}\)</span>.</p>
</div>
<div class="section" id="example-advection-diffusion">
<h2>Example: Advection-Diffusion<a class="headerlink" href="#example-advection-diffusion" title="Permalink to this headline">¶</a></h2>
<p>The following function can be used to setup the numerical approximation of the aforementioned advection-diffusion model.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyapprox</span> <span class="k">as</span> <span class="nn">pya</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">setup_model</span><span class="p">(</span><span class="n">num_vars</span><span class="p">,</span><span class="n">corr_len</span><span class="p">,</span><span class="n">max_eval_concurrency</span><span class="p">):</span>
    <span class="n">second_order_timestepping</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">final_time</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="kn">from</span> <span class="nn">pyapprox.fenics_models.advection_diffusion</span> <span class="kn">import</span> <span class="n">qoi_functional_misc</span><span class="p">,</span>\
        <span class="n">AdvectionDiffusionModel</span>
    <span class="n">qoi_functional</span><span class="o">=</span><span class="n">qoi_functional_misc</span>
    <span class="n">degree</span><span class="o">=</span><span class="mi">1</span>
    <span class="c1"># setup advection diffusion finite element model</span>
    <span class="n">base_model</span> <span class="o">=</span> <span class="n">AdvectionDiffusionModel</span><span class="p">(</span>
        <span class="n">num_vars</span><span class="p">,</span><span class="n">corr_len</span><span class="p">,</span><span class="n">final_time</span><span class="p">,</span><span class="n">degree</span><span class="p">,</span><span class="n">qoi_functional</span><span class="p">,</span>
        <span class="n">add_work_to_qoi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">second_order_timestepping</span><span class="o">=</span><span class="n">second_order_timestepping</span><span class="p">)</span>
    <span class="c1"># add wrapper to allow execution times to be captured</span>
    <span class="n">timer_model</span> <span class="o">=</span> <span class="n">pya</span><span class="o">.</span><span class="n">TimerModelWrapper</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span><span class="n">base_model</span><span class="p">)</span>
    <span class="c1"># add wraper to allow model runs to be run on independent threads</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pya</span><span class="o">.</span><span class="n">PoolModel</span><span class="p">(</span><span class="n">timer_model</span><span class="p">,</span><span class="n">max_eval_concurrency</span><span class="p">,</span>
                      <span class="n">base_model</span><span class="o">=</span><span class="n">base_model</span><span class="p">)</span>
    <span class="c1"># add wrapper that tracks execution times.</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pya</span><span class="o">.</span><span class="n">WorkTrackingModel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Could not import Torch
</pre></div>
</div>
<p>The following code computes the expectation of the QoI for a set of model discretization choices</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">error_vs_cost</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">generate_random_samples</span><span class="p">,</span><span class="n">validation_levels</span><span class="p">,</span>
                  <span class="n">num_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">validation_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">)</span><span class="o">==</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">num_config_vars</span>
    <span class="n">config_vars</span> <span class="o">=</span> <span class="n">pya</span><span class="o">.</span><span class="n">cartesian_product</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">validation_levels</span><span class="p">])</span>

    <span class="n">random_samples</span><span class="o">=</span><span class="n">generate_random_samples</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">pya</span><span class="o">.</span><span class="n">get_all_sample_combinations</span><span class="p">(</span><span class="n">random_samples</span><span class="p">,</span><span class="n">config_vars</span><span class="p">)</span>

    <span class="n">reference_samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,::</span><span class="n">config_vars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">reference_samples</span><span class="p">[</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">num_config_vars</span><span class="p">:,:]</span><span class="o">=</span>\
            <span class="n">validation_levels</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="n">reference_values</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">reference_samples</span><span class="p">)</span>
    <span class="n">reference_mean</span> <span class="o">=</span> <span class="n">reference_values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

    <span class="c1"># put keys in order returned by cartesian product</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">work_tracker</span><span class="o">.</span><span class="n">costs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="c1"># remove validation key associated with validation samples</span>
    <span class="n">costs</span><span class="p">,</span><span class="n">ndofs</span><span class="p">,</span><span class="n">means</span><span class="p">,</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)):</span>
        <span class="n">key</span><span class="o">=</span><span class="n">keys</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">work_tracker</span><span class="o">.</span><span class="n">costs</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">dt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">get_degrees_of_freedom_and_timestep</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">ndofs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">final_time</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">ii</span><span class="p">::</span><span class="n">config_vars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">reference_mean</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">reference_mean</span><span class="p">))</span>

    <span class="n">times</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># make costs relative</span>
    <span class="n">costs</span> <span class="o">/=</span> <span class="n">costs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span> <span class="o">=</span> <span class="n">validation_levels</span>
    <span class="n">indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">costs</span><span class="p">),(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">ndofs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ndofs</span><span class="p">),(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">errors</span><span class="p">),(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">times</span><span class="p">),(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

    <span class="n">validation_index</span> <span class="o">=</span> <span class="n">reference_samples</span><span class="p">[</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">num_config_vars</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">validation_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">work_tracker</span><span class="o">.</span><span class="n">costs</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">)])</span>
    <span class="n">validation_cost</span> <span class="o">=</span> <span class="n">validation_time</span><span class="o">/</span><span class="n">costs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">validation_ndof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">reference_values</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;costs&quot;</span><span class="p">:</span><span class="n">costs</span><span class="p">,</span><span class="s2">&quot;errors&quot;</span><span class="p">:</span><span class="n">errors</span><span class="p">,</span><span class="s2">&quot;indices&quot;</span><span class="p">:</span><span class="n">indices</span><span class="p">,</span>
            <span class="s2">&quot;times&quot;</span><span class="p">:</span><span class="n">times</span><span class="p">,</span><span class="s2">&quot;validation_index&quot;</span><span class="p">:</span><span class="n">validation_index</span><span class="p">,</span>
            <span class="s2">&quot;validation_cost&quot;</span><span class="p">:</span><span class="n">validation_cost</span><span class="p">,</span><span class="s2">&quot;validation_ndof&quot;</span><span class="p">:</span><span class="n">validation_ndof</span><span class="p">,</span>
            <span class="s2">&quot;validation_time&quot;</span><span class="p">:</span><span class="n">validation_time</span><span class="p">,</span><span class="s2">&quot;ndofs&quot;</span><span class="p">:</span><span class="n">ndofs</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p>We can use this function to plot the error in the QoI mean as a function of the discretization parameters.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_error_vs_cost</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">cost_type</span><span class="o">=</span><span class="s1">&#39;ndof&#39;</span><span class="p">):</span>

    <span class="n">errors</span><span class="p">,</span><span class="n">costs</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;costs&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cost_type</span><span class="o">==</span><span class="s1">&#39;ndof&#39;</span><span class="p">:</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ndofs&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ndofs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1">#print(&#39;validation_time&#39;,data[&#39;validation_time&#39;],data[&#39;validation_index&#39;])</span>
    <span class="kn">from</span> <span class="nn">pyapprox.convert_to_latex_table</span> <span class="kn">import</span> <span class="n">convert_to_latex_table</span>

    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.titlesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="n">validation_levels</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">),</span>
                           <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                           <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$(\cdot)$&#39;</span>
        <span class="n">axs</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">costs</span><span class="p">,</span><span class="n">errors</span><span class="p">,</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$(\cdot,</span><span class="si">%d</span><span class="s1">)$&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">costs</span><span class="p">[:,</span><span class="n">ii</span><span class="p">],</span><span class="n">errors</span><span class="p">[:,</span><span class="n">ii</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$(</span><span class="si">%d</span><span class="s1">,\cdot)$&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">costs</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span><span class="n">errors</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">jj</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$(\cdot,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">)$&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">costs</span><span class="p">[:,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">],</span><span class="n">errors</span><span class="p">[:,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">jj</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$(</span><span class="si">%d</span><span class="s1">,\cdot,</span><span class="si">%d</span><span class="s1">)$&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">costs</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,</span><span class="n">jj</span><span class="p">],</span><span class="n">errors</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,</span><span class="n">jj</span><span class="p">],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="n">jj</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$(</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,\cdot)$&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">costs</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:],</span><span class="n">errors</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:],</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># plot expected congergence rates</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">validation_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="n">validation_levels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">costs</span><span class="p">[:,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">],</span><span class="n">costs</span><span class="p">[:,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">costs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span>
                      <span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">validation_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">costs</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,</span><span class="n">jj</span><span class="p">],</span><span class="n">costs</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,</span><span class="n">jj</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">costs</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span>
                      <span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="n">validation_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">costs</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:],</span>
                      <span class="n">costs</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">costs</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-1</span><span class="p">,</span>
                      <span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_levels</span><span class="p">)):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathrm</span><span class="si">{Work}</span><span class="s1">$ $W_{\boldsymbol{\alpha}}$&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\left\lvert \mathbb</span><span class="si">{E}</span><span class="s1">[f]-\mathbb</span><span class="si">{E}</span><span class="s1">[f_{\boldsymbol{\alpha}}]\right\rvert / \left\lvert \mathbb</span><span class="si">{E}</span><span class="s1">[f]\right\rvert$&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span><span class="n">axs</span>

<span class="k">def</span> <span class="nf">generate_random_samples</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">pya</span><span class="o">.</span><span class="n">halton_sequence</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samples</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">num_vars</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">setup_model</span><span class="p">(</span><span class="n">num_vars</span><span class="p">,</span><span class="n">corr_len</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">max_eval_concurrency</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">validation_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">error_vs_cost</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span><span class="n">partial</span><span class="p">(</span><span class="n">generate_random_samples</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">num_vars</span><span class="p">),</span>
    <span class="n">validation_levels</span><span class="p">)</span>
<span class="n">plot_error_vs_cost</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/sphx_glr_plot_advection_diffusion_model_001.png" class="sphx-glr-single-img" src="../../_images/sphx_glr_plot_advection_diffusion_model_001.png" />
<p>The above figure depicts the changes induced in the error of the mean of the QoI, i.e. <span class="math notranslate nohighlight">\(\mathbb{E}[f_\ai]\)</span>, as the mesh and temporal discretizations are changed.  The legend labels denote the mesh discretization parameter values <span class="math notranslate nohighlight">\((\alpha_1,\alpha_2,\alpha_3)\)</span> used to solve the advection diffusion equation. Numeric values represent discretization parameters that are held fixed while the symbol <span class="math notranslate nohighlight">\(\cdot\)</span> denotes that the corresponding parameter is varying. The reference solution is obtained using the model indexed by <span class="math notranslate nohighlight">\((6,6,6)\)</span>.</p>
<p>The dashed lines represent the theoretical rates of the convergence of the deterministic error when refining <span class="math notranslate nohighlight">\(h_1\)</span> (left), <span class="math notranslate nohighlight">\(h_2\)</span> (middle), and <span class="math notranslate nohighlight">\(\Delta t\)</span> (right).
The error decreases quadratically with both <span class="math notranslate nohighlight">\(h_1\)</span> and <span class="math notranslate nohighlight">\(h_2\)</span> and linearly with <span class="math notranslate nohighlight">\(\Delta t\)</span> until a saturation point is reached. These saturation points occur when the error induced by a coarse resolution in one mesh parameter dominates the others. For example the left plot shows that when refining <span class="math notranslate nohighlight">\(h_1\)</span> the final error in <span class="math notranslate nohighlight">\(\mathbb{E}[f]\)</span> is dictated by the error induced by using the mesh size <span class="math notranslate nohighlight">\(h_2\)</span>, provided <span class="math notranslate nohighlight">\(\Delta t\)</span> is small enough. Similarly the right plot shows, that for fixed <span class="math notranslate nohighlight">\(h_2\)</span>, the highest accuracy that can be obtained by refining <span class="math notranslate nohighlight">\(\Delta t\)</span> is dependent on the resolution of <span class="math notranslate nohighlight">\(h_1\)</span>.</p>
<p>Note the expectations computed in the tutorial is estimated using the same 10 samples for all model resolutions. This allows the error in the statistical estimate induced by small numbers of samples to be ignored. The effect of sample size on Monte Carlo estimates of expectations is covered in <span class="xref std std-ref">sphx_glr_auto_tutorials_multi_fidelity_plot_monte_carlo.py</span>.</p>
<div class="section" id="references">
<h3>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h3>
<dl class="citation">
<dt class="label" id="ntwsiamna2008"><span class="brackets"><a class="fn-backref" href="#id1">NTWSIAMNA2008</a></span></dt>
<dd><p><a class="reference external" href="https://doi.org/10.1137/060663660">Nobile F, Tempone R, Webster CG. A Sparse Grid Stochastic Collocation Method for Partial Differential Equations with Random Input Data. SIAM Journal on Numerical Analysis 2008;46(5):2309–2345.</a></p>
</dd>
</dl>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 3 minutes  29.561 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-tutorials-foundations-plot-advection-diffusion-model-py">
<div class="sphx-glr-download docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/7b5c45d48f70c2f58a7198e3cc46cb18/plot_advection_diffusion_model.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_advection_diffusion_model.py</span></code></a></p>
</div>
<div class="sphx-glr-download docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/3d93f9901dfff232b3afd80be56f42da/plot_advection_diffusion_model.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_advection_diffusion_model.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="plot_monte_carlo.html" class="btn btn-neutral float-right" title="Monte Carlo Quadrature" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="PyApprox Tutorials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019 National Technology &amp; Engineering Solutions of Sandia, LLC (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the U.S. Government retains certain rights in this software.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>